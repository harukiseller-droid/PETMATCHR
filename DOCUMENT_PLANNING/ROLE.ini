ROLE
Mày là AI coder phụ trách project PetMatchr. Code hiện đang chạy đúng, nhiệm vụ của mày là UPDATE NHẸ để tích hợp quiz mới `lifestyle-match` mà KHÔNG PHÁ cấu trúc tool đang có.

CONTEXT QUAN TRỌNG
– Repo này đã có spec đầy đủ trong:
  • `DOCUMENT_PLANNING/AI coder.md`
  • `DOCUMENT_PLANNING/IMPLEMENTATION_PLAN.md`
  • `DOCUMENT_PLANNING/V7_PETMATCHR  – BEST FINAL VERSION.md`
  • `DOCUMENT_PLANNING/V7_tech1_JSON BREEDS_LIFESTYLE_SCORES_JSON CONTENT_Pseudo-code.md`
  • `DOCUMENT_PLANNING/V7_tech2_Mapping PAGE_MONETIZATION_CTA_Pseudo-code generate batch pages.md`
  • `DOCUMENT_PLANNING/V7_tech3_prompt.md`
  • `DOCUMENT_PLANNING/V7_tech4_AEO_quick_answers_schema.md`
  • `DOCUMENT_PLANNING/verify_task.md`

– Các file TECH cần đọc:
  • `src/data/quizzes/lifestyle-match.json`  (tao đã copy JSON quiz mới vào đây rồi)
  • `src/data/quizzes/*.json` (các quiz cũ)
  • `src/lib/types.ts` hoặc file định nghĩa `QuizDefinition`, `QuizResult`, `PageType` (tùy project)
  • `src/lib/quiz-utils.ts` (nếu có)
  • `src/app/quiz/[slug]/page.tsx` hoặc components liên quan đến render quiz
  • `src/app/api/quiz/*` nếu có API layer
  • `scripts/prompts.ts`
  • `quiz-types.ts` hoặc file mapping quiz

YÊU CẦU TỔNG THỂ
– Giữ nguyên kiến trúc hiện tại, KHÔNG refactor lớn, KHÔNG đổi tên type/global trừ khi thật sự cần.
– ƯU TIÊN: thêm logic để quiz `lifestyle-match` trở thành front-door experience:
  1) Quiz 2 phase (quick profile + deep dive) nhưng dùng chính JSON đã có.
  2) Sau khi trả lời xong => tạo profile label + top dog matches (sẽ dùng helper matchBreedsForPersona).
  3) Không phá các quiz khác (insurance-fit, behavior-check, anxiety-level…).

– Mọi thay đổi phải:
  • Pass typecheck (TypeScript)
  • Không làm hỏng router / pages hiện có
  • Không đụng vào logic hybrid LLM / generate pages (PHASE 13–14–15) trừ khi cần thêm hook nhỏ.

NHIỆM VỤ CHI TIẾT

BƯỚC 1 – ĐỌC & HIỂU SPEC
1. Đọc nhanh:
   – `DOCUMENT_PLANNING/AI coder.md`
   – `DOCUMENT_PLANNING/IMPLEMENTATION_PLAN.md` (ưu tiên PHASE 8, 13, 14, 15, 16,  nếu có)
   – `DOCUMENT_PLANNING/V7_PETMATCHR  – BEST FINAL VERSION.md`
2. Đọc code hiện tại:
   – type định nghĩa quiz (QuizDefinition, QuizQuestion, QuizResult…)
   – route `/quiz/[slug]` và mọi component liên quan quiz.

ĐỪNG CODE GÌ trước khi tóm tắt lại cho tao (và cho chính mày) cách hiện tại trang quiz đang render như nào.

BƯỚC 2 – VERIFY FILE `lifestyle-match.json`
1. Load `src/data/quizzes/lifestyle-match.json`.
2. Kiểm tra:
   – JSON hợp lệ, match với type `QuizDefinition` hiện tại.
   – Nếu bị lệch field (vd thiếu `result_mapping` field nào) thì:
     • Thay đổi JSON ít nhất có thể để khớp type, KHÔNG tự tiện đổi type trong `types.ts` trừ khi an toàn.
3. Đảm bảo quiz mới được include trong bất kỳ nơi nào đang load danh sách quiz (nếu có).

BƯỚC 3 – CẬP NHẬT MAPPING QUIZ TYPES
1. Mở `quiz-types.ts` (hoặc file mapping quiz).
2. Đảm bảo:
   – `lifestyle-match` được khai báo với:
     • `slug: "lifestyle-match"`
     • `cluster: "lifestyle"`
     • conversion_goal = "lead_form" hoặc giống JSON.
   – Không xoá mapping quiz cũ.

BƯỚC 4 – THÊM HELPER matchBreedsForPersona
1. Tạo file mới `src/lib/lifestyle-match.ts` (nếu chưa có).
2. Định nghĩa hàm:

   ```ts
   export type LifestyleMatchInput = {
     answers: Record<string, string | string[]>;
     breeds: Breed[];
     lifestyleScores: LifestyleScore[];
   };

   export type LifestyleMatchResult = {
     profile_label: string;
     profile_slug: string;
     description: string;
     top_matches: {
       breed_slug: string;
       match_score: number;
       explanation_bullets: string[];
       key_traits: {
         energy_label: string;
         apartment_score: number;
         kid_friendly_score: number;
         shedding_level: "low" | "medium" | "high";
         monthly_cost_range: [number, number] | null;
       };
     }[];
   };

   export function matchBreedsForPersona(input: LifestyleMatchInput): LifestyleMatchResult { ... }
Logic gợi ý:
– Đọc answers và tags từ quiz mới.
– Dùng LifestyleScore + trait energy, shedding, kid_friendly, apartment_suitable, cost_level.
– Tạo match_score 0–100 và sort top 3–5 breeds.

KHÔNG gọi LLM trong hàm này. Chỉ dùng data JSON.

BƯỚC 5 – UPDATE ROUTE /quiz/lifestyle-match

Trong src/app/quiz/[slug]/page.tsx (hoặc tương tự), thêm logic:
– Nếu slug === "lifestyle-match":
• Render quiz 2 "phase":
– Phase 1 = các câu profile_*.
– Phase 2 = các câu deep_*.
– Nhưng thực chất vẫn submit cùng 1 form (hoặc 2 step UI).
• Sau khi user submit:
– Gom answers từ form.
– Gọi matchBreedsForPersona với:
– toàn bộ breeds từ breeds.json
– lifestyleScores từ lifestyle_scores.json.
– Render 1 RESULT VIEW:
– Profile label (từ result_mapping + logic score trong quiz).
– Top 3–5 breeds:
• Tên breed + match_score + 3–5 bullet giải thích.
• Buttons:
– “View full guide” → link breed page.
– “View cost breakdown” (nếu có cost page default city).
– Bảng comparison 3 cột (cơ bản).
– Đảm bảo các quiz khác (insurance-fit, behavior-check, anxiety-level) vẫn chạy như cũ.

BƯỚC 6 – KẾT NỐI VỚI FUNNELS

Nếu có PageMonetization/mapping quiz → email:
– Đảm bảo lifestyle-match có email_sequence_id mapping như trong JSON.

Kết quả quiz:
– Nếu project đã có logic “send quiz_result event / save lead” → reuse y chang cho lifestyle-match.

BƯỚC 7 – QA & SAFETY

Chạy:
– npm run lint (nếu có)
– npm run typecheck hoặc tsc --noEmit
– npm run dev và check /quiz/lifestyle-match + 1–2 quiz cũ.

Đảm bảo:
– Không lỗi runtime.
– Không 500 khi slug quiz khác.

CÁCH MÀY TRẢ LỜI
– Bước 1: Tóm tắt ngắn cách hệ thống quiz hiện tại đang hoạt động.
– Bước 2: Liệt kê file nào cần sửa/thêm.
– Bước 3: Show DIFF / code mới cho từng file theo thứ tự (quiz-types.ts → lifestyle-match.ts → quiz page).
– Bước 4: Ghi rõ lệnh để tao chạy QA/local test.

TUYỆT ĐỐI KHÔNG
– Không refactor toàn bộ structure quiz.
– Không self-invent spec mới khác V7.
– Không xoá quiz cũ / mapping cũ.

